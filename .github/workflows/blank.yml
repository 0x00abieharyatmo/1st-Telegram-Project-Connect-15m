name: ğŸš€ Auto Cool Level Generator

on:
  schedule:
    - cron: '*/15 * * * *' # Every 15 minutes
  workflow_dispatch:

jobs:
  generate-level:
    name: ğŸŒŸ Generate Cool Level
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ•µï¸ Set Executor Email Manual
        run: |
          echo "ACTOR_EMAIL=abieharyatmo01@gmail.com" >> $GITHUB_ENV

      - name: ğŸ“ Log Executor Email Only
        run: |
          mkdir -p levels
          echo "${{ env.ACTOR_EMAIL }}" >> levels/executors.log

      - name: ğŸ“ Generate Next Cool Level
        shell: bash
        run: |
          set -e
          cool_names=( "Vortex" "Nebula" "Phoenix" "Falcon" "Titan" "Shadow" "Blaze" "Nova" "Specter" "Stellar" "Inferno" "Cosmos" "Zephyr" "Obsidian" "Glacier" "Thunder" "Matrix" "Aurora" "Samurai" "Ninja" "Ronin" "Valkyrie" "Oracle" "Sonic" "Ranger" "Drift" "Mirage" "Cipher" "Echo" "Titanium" "Genesis" "Saber" "Onyx" "Blizzard" "Venom" "Storm" "Astro" "Galaxy" "Eclipse" "Magma" "Turbo" "Rogue" "Elemental" "Surge" "Radiant" "Zenith" "Prime" "Sentinel" "Golem" "Mystic" )
          programmer_quotes=( "â€œTalk is cheap. Show me the code.â€ â€“ Linus Torvalds" "â€œPrograms must be written for people to read, and only incidentally for machines to execute.â€ â€“ Harold Abelson" "â€œFirst, solve the problem. Then, write the code.â€ â€“ John Johnson" "â€œSimplicity is the soul of efficiency.â€ â€“ Austin Freeman" "â€œCode is like humor. When you have to explain it, itâ€™s bad.â€ â€“ Cory House" "â€œExperience is the name everyone gives to their mistakes.â€ â€“ Oscar Wilde" "â€œFix the cause, not the symptom.â€ â€“ Steve Maguire" "â€œBefore software can be reusable it first has to be usable.â€ â€“ Ralph Johnson" "â€œMake it work, make it right, make it fast.â€ â€“ Kent Beck" "â€œThe best error message is the one that never shows up.â€ â€“ Thomas Fuchs" )
          RANDOM_QUOTE="${programmer_quotes[$RANDOM % ${#programmer_quotes[@]}]}"
          echo "PROGRAMMER_QUOTE=$RANDOM_QUOTE" >> $GITHUB_ENV

          mkdir -p levels

          last_name=""
          if ls levels/level-*-*.txt 1> /dev/null 2>&1; then
            last_file=$(ls levels/level-*-*.txt | sort | tail -n 1)
            last_name=$(basename "$last_file" | sed -E 's/level-[0-9]{8}-[0-9]{4}-(.*)\.txt/\1/')
          fi

          idx=0
          if [ -n "$last_name" ]; then
            for i in "${!cool_names[@]}"; do
              if [[ "${cool_names[$i]}" == "$last_name" ]]; then
                idx=$(( (i + 1) % ${#cool_names[@]} ))
                break
              fi
            done
          fi

          next_name="${cool_names[$idx]}"
          file_name="levels/level-$(date +%Y%m%d-%H%M)-${next_name}.txt"

          {
            echo "# ğŸŒŒ Level: $next_name"
            echo "# Generated at: $(date -u)"
            echo "# By: abieharyatmo01@gmail.com"
          } > "$file_name"

          echo "LEVEL_NAME=$next_name" >> $GITHUB_ENV
          echo "Created $file_name"

      - name: â° Generate Formatted Time
        run: |
          echo "FORMATTED_TIME=$(TZ='Asia/Jakarta' date '+%d/%m/%Y %H:%M:%S WIB')" >> $GITHUB_ENV

      - name: ğŸ”¢ Generate Notification Counter
        id: notif-counter
        run: |
          count=$(ls levels/level-*-*.txt 2>/dev/null | wc -l)
          echo "NOTIF_COUNTER=$count" >> $GITHUB_ENV

      # Leaderboard eksekutor lokal repo (hanya email)
      - name: ğŸ† Generate User Leaderboard (Email Only)
        run: |
          mkdir -p levels
          awk '{ email[$1]++ } END { n=1; for (i in email) print n ". " i " (" email[i] "x)"; n++ }' levels/executors.log > levels/user-leaderboard.txt

      # Download leaderboard dari repo lain
      - name: ğŸ”„ Download Leaderboard dari Repo Lain
        run: |
          curl -s -o levels/leaderboard-repo-lain.txt \
            "https://raw.githubusercontent.com/0x00abieharyatmo/1st-Telegram-Project-Connect-15m/main/levels/user-leaderboard.txt" || touch levels/leaderboard-repo-lain.txt

      # Gabungkan leaderboard lokal dan repo lain, hasil final hanya 1 list gabungan tanpa judul tambahan
      - name: ğŸ† Gabung & Sederhanakan Leaderboard Gabungan (Email Only, Simple)
        run: |
          # Gabung semua email dari dua leaderboard, hitung total, hapus duplikat
          cat levels/user-leaderboard.txt levels/leaderboard-repo-lain.txt | grep -E "^[0-9]+\. " | awk '{print $2}' > levels/all_emails.tmp
          cat levels/all_emails.tmp levels/all_emails.tmp | sort | uniq > levels/all_emails.txt
          # Hitung total eksekusi per email dari kedua sumber
          > levels/leaderboard-gabungan.txt
          echo "ğŸ† Leaderboard Gabungan" > levels/leaderboard-gabungan.txt
          echo "============================" >> levels/leaderboard-gabungan.txt
          n=1
          while read email; do
            count1=$(grep -w "$email" levels/user-leaderboard.txt | grep -o '([0-9]\+x)' | sed 's/[^0-9]//g')
            count2=$(grep -w "$email" levels/leaderboard-repo-lain.txt | grep -o '([0-9]\+x)' | sed 's/[^0-9]//g')
            total=$(( (${count1:-0}) + (${count2:-0}) ))
            if [ "$total" -gt 0 ]; then
              echo "$n. $email ($total x)" >> levels/leaderboard-gabungan.txt
              n=$((n + 1))
            fi
          done < levels/all_emails.txt

      - name: ğŸ“¤ Set Leaderboard Env Gabungan
        run: |
          BOARD=$(cat levels/leaderboard-gabungan.txt | tr '\n' '\r\n')
          echo "LEADERBOARD=${BOARD}" >> $GITHUB_ENV

      - name: ğŸ”” Send Notification to Telegram
        uses: appleboy/telegram-action@v0.1.0
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            <b>ğŸ† Leaderboard Gabungan:</b>
            <pre>${{ env.LEADERBOARD }}</pre>

            <b>#DeployLikeAPro #DevOpsMode</b>
            <b>ğŸ’¯ This script was 100% created by Abie Haryatmo</b>
            <i>${{ env.PROGRAMMER_QUOTE }}</i>
          format: html

      - name: ğŸ¤– Configure Git
        run: |
          git config user.name "abieharyatmo01"
          git config user.email "abieharyatmo01@gmail.com"

      - name: ğŸš© Commit & Push Changes
        run: |
          git add levels/
          git commit -m "âœ¨ Add Level: ${{ env.LEVEL_NAME }} (by abieharyatmo01@gmail.com)" || echo "Nothing to commit"
          git push
