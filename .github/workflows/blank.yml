name: 🚀 Auto Cool Level Generator (Leaderboard Gabungan by Email)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  generate-level:
    name: 🌟 Generate Cool Level & Leaderboard Gabungan
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Code
        uses: actions/checkout@v4

      - name: 🕵️ Get GitHub User Info
        id: get_actor
        run: |
          USERNAME="${{ github.actor }}"
          EMAIL=$(curl -s https://api.github.com/users/$USERNAME | grep '"email":' | head -1 | awk -F '"' '{print $4}')
          if [ -z "$EMAIL" ] || [ "$EMAIL" = "null" ]; then
            EMAIL="$USERNAME@users.noreply.github.com"
          fi
          echo "ACTOR_EMAIL=$EMAIL" >> $GITHUB_ENV

      - name: 📝 Log Executor Email
        run: |
          mkdir -p levels
          echo "${{ env.ACTOR_EMAIL }} - $(date -u)" >> levels/executors.log

      # Leaderboard lokal repo ini berdasarkan email saja
      - name: 🏆 Generate User Leaderboard (by Email Only)
        run: |
          mkdir -p levels
          awk '{ email[$1]++ } END { n=1; for (i in email) print n ". " i " (" email[i] "x)"; n++ }' levels/executors.log > levels/user-leaderboard.txt
          sed -i '1s/^/🏆 Leaderboard Eksekutor Workflow\n===============================\n/' levels/user-leaderboard.txt

      # Download leaderboard dari repo lain
      - name: 🔄 Download Leaderboard dari Repo Lain
        run: |
          # Ganti dengan repo lain yang mau kamu tampilkan leaderboard-nya
          curl -s -o levels/leaderboard-repo-lain.txt \
            "https://raw.githubusercontent.com/0x00abieharyatmo/1st-Telegram-Project-Connect-15m/main/levels/user-leaderboard.txt" || touch levels/leaderboard-repo-lain.txt

      # Gabungkan leaderboard lokal dan dari repo lain, by email only & rapi
      - name: 🏆 Gabung Leaderboard Cross-Repo (Email Only)
        run: |
          echo "🏆 Leaderboard Gabungan" > levels/leaderboard-gabungan.txt
          echo "============================" >> levels/leaderboard-gabungan.txt
          echo "" >> levels/leaderboard-gabungan.txt
          echo "Leaderboard Repo Ini:" >> levels/leaderboard-gabungan.txt
          tail -n +3 levels/user-leaderboard.txt >> levels/leaderboard-gabungan.txt
          echo "" >> levels/leaderboard-gabungan.txt
          echo "Leaderboard Repo Lain:" >> levels/leaderboard-gabungan.txt
          tail -n +3 levels/leaderboard-repo-lain.txt >> levels/leaderboard-gabungan.txt

      # Set leaderboard gabungan ke env untuk Telegram
      - name: 📤 Set Leaderboard Env Gabungan
        run: |
          BOARD=$(cat levels/leaderboard-gabungan.txt | tr '\n' '\r\n')
          echo "LEADERBOARD=${BOARD}" >> $GITHUB_ENV

      - name: 🔔 Send Notification to Telegram
        uses: appleboy/telegram-action@v0.1.0
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            <b>🏆 Leaderboard Gabungan:</b>
            <pre>${{ env.LEADERBOARD }}</pre>

            <b>#DeployLikeAPro #DevOpsMode</b>
          format: html

      - name: 🤖 Configure Git
        run: |
          git config user.name "abieharyatmo01"
          git config user.email "abieharyatmo01@gmail.com"

      - name: 🚩 Commit & Push Changes
        run: |
          git add levels/
          git commit -m "✨ Update leaderboard (by email)" || echo "Nothing to commit"
          git push
